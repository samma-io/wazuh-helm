apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ .Release.Name }}-indexer
  namespace: {{ .Release.Namespace }}
  {{- with .Values.global.labels }}
  labels:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  replicas: {{ .Values.indexer.replicas }}
  selector:
    matchLabels:
      app: {{ .Release.Name }}-indexer
      node-type: index
  serviceName: wazuh-cluster
  podManagementPolicy: Parallel
  {{- with .Values.indexer.strategy }}
  updateStrategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}-indexer
        node-type: index
        {{- with .Values.global.labels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with .Values.global.annotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      name: {{ .Release.Name }}-indexer
    spec:
      {{- with .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
      containers:
        - name: wazuh-indexer
          image: {{ .Values.indexer.image.repository }}:{{ .Values.wazuh.tag }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: OPENSEARCH_JAVA_OPTS
              value: {{ .Values.indexer.javaOpts | quote }}
            - name: bootstrap.memory_lock
              value: "true"
            
            - name: node.name
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: cluster.name
              value: "wazuh-cluster"
            - name: node.max_local_storage_nodes
              value: "1"
            
            - name: network.host
              value: "0.0.0.0"
            - name: http.port
              value: "9200"
            - name: transport.port
              value: "9300"
            
            - name: compatibility.override_main_response_version
              value: "true"
            - name: plugins.security.ssl.http.enabled
              value: "true"
            - name: plugins.security.ssl.http.pemcert_filepath
              value: "/usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem"
            - name: plugins.security.ssl.http.pemkey_filepath
              value: "/usr/share/wazuh-indexer/config/certs/wazuh.indexer.key"
            - name: plugins.security.ssl.http.pemtrustedcas_filepath
              value: "/usr/share/wazuh-indexer/config/certs/root-ca.pem"
            
            - name: plugins.security.ssl.transport.pemcert_filepath
              value: "/usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem"
            - name: plugins.security.ssl.transport.pemkey_filepath
              value: "/usr/share/wazuh-indexer/config/certs/wazuh.indexer.key"
            - name: plugins.security.ssl.transport.pemtrustedcas_filepath
              value: "/usr/share/wazuh-indexer/config/certs/root-ca.pem"
            - name: plugins.security.ssl.transport.enforce_hostname_verification
              value: "false"
            - name: plugins.security.ssl.transport.resolve_hostname
              value: "false"
            
            - name: plugins.security.nodes_dn
              value: "CN=wazuh.indexer,OU=Wazuh,O=Wazuh,L=California,C=US"
            - name: plugins.security.authcz.admin_dn
              value: "CN=admin,OU=Wazuh,O=Wazuh,L=California,C=US"
            
            - name: plugins.security.allow_default_init_securityindex
              value: "true"
            - name: plugins.security.restapi.roles_enabled
              value: '["all_access","security_rest_api_access"]'
            - name: plugins.security.system_indices.enabled
              value: "true"
            - name: plugins.security.system_indices.indices
              value: '[".opendistro-alerting-config",".opendistro-alerting-alert*",".opendistro-anomaly-results*",".opendistro-anomaly-detector*",".opendistro-anomaly-checkpoints",".opendistro-anomaly-detection-state",".opendistro-reports-*",".opendistro-notifications-*",".opendistro-notebooks",".opensearch-observability",".opendistro-asynchronous-search-response*",".replication-metadata-store"]'
            - name: plugins.security.check_snapshot_restore_write_privileges
              value: "true"
            - name: plugins.security.enable_snapshot_restore_privilege
              value: "true"
            
            - name: cluster.routing.allocation.disk.threshold_enabled
              value: "false"
            
            - name: INDEXER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-indexer-creds
                  key: username
            - name: INDEXER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-indexer-creds
                  key: password
          
          ports:
            - containerPort: 9200
              name: http
            - containerPort: 9300
              name: transport
          
          resources:
            {{- toYaml .Values.indexer.resources | nindent 12 }}
          
          volumeMounts:
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch.yml
              subPath: opensearch.yml
              readOnly: true
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch-security/internal_users.yml
              subPath: internal_users.yml
              readOnly: true
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch-security/roles.yml
              subPath: roles.yml
              readOnly: true
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch-security/roles_mapping.yml
              subPath: roles_mapping.yml
              readOnly: true
            - name: data
              mountPath: /var/lib/wazuh-indexer
            - name: certs-root
              mountPath: /usr/share/wazuh-indexer/config/certs/root-ca.pem
              subPath: ca.crt
              readOnly: true
            - name: certs-indexer
              mountPath: /usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem
              subPath: tls.crt
              readOnly: true
            - name: certs-indexer
              mountPath: /usr/share/wazuh-indexer/config/certs/wazuh.indexer.key
              subPath: tls.key
              readOnly: true
            - name: certs-admin
              mountPath: /usr/share/wazuh-indexer/config/certs/admin.pem
              subPath: tls.crt
              readOnly: true
            - name: certs-admin
              mountPath: /usr/share/wazuh-indexer/config/certs/admin-key.pem
              subPath: tls.key
              readOnly: true
          
          {{- if .Values.indexer.startupProbe.enabled }}
          startupProbe:
            tcpSocket:
              port: 9200
            initialDelaySeconds: {{ .Values.indexer.startupProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.indexer.startupProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.indexer.startupProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.indexer.startupProbe.failureThreshold }}
          {{- end }}
          
          {{- if .Values.indexer.livenessProbe.enabled }}
          livenessProbe:
            tcpSocket:
              port: 9200
            initialDelaySeconds: {{ .Values.indexer.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.indexer.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.indexer.livenessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.indexer.livenessProbe.failureThreshold }}
          {{- end }}
          
          {{- if .Values.indexer.readinessProbe.enabled }}
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  #!/bin/sh
                  # Check cluster health with authentication
                  RESPONSE=$(curl -sk -u "${INDEXER_USERNAME}:${INDEXER_PASSWORD}" \
                    "https://localhost:9200/_cluster/health?local=true" 2>/dev/null)
                  
                  # Check if response contains green or yellow status
                  echo "$RESPONSE" | grep -q '"status":"green"' || \
                  echo "$RESPONSE" | grep -q '"status":"yellow"'
            initialDelaySeconds: {{ .Values.indexer.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.indexer.readinessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.indexer.readinessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.indexer.readinessProbe.failureThreshold }}
          {{- end }}
      
      volumes:
        - name: config
          configMap:
            name: {{ .Release.Name }}-indexer-conf
        - name: certs-root
          secret:
            secretName: {{ .Release.Name }}-rootca-certificate
        - name: certs-indexer
          secret:
            secretName: {{ .Release.Name }}-indexer
        - name: certs-admin
          secret:
            secretName: {{ .Release.Name }}-admin
  
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: 
          - {{ .Values.indexer.persistence.accessMode }}
        {{- if .Values.indexer.persistence.storageClass }}
        {{- if eq .Values.indexer.persistence.storageClass "-" }}
        storageClassName: ""
        {{- else }}
        storageClassName: {{ .Values.global.storageClass | quote }}
        {{- end }}
        {{- else if .Values.global.storageClass }}
        {{- if eq .Values.global.storageClass "-" }}
        storageClassName: ""
        {{- else }}
        storageClassName: {{ .Values.global.storageClass | quote }}
        {{- end }}
        {{- end }}
        resources:
          requests:
            storage: {{ .Values.indexer.persistence.size }}